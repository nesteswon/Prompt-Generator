import streamlit as st
from openai import OpenAI

# ğŸ” Streamlit Secrets ì—ì„œ OpenAI API Key ê°€ì ¸ì˜¤ê¸°
OPENAI_API_KEY = st.secrets["openai_api_key"]

# ==============================================================================
# [1] System Instruction ì„¤ì • (ì—­í•  + ê·œì¹™)
# ==============================================================================
SYSTEM_INSTRUCTION = """
ë‹¹ì‹ ì€ ì…ë ¥ëœ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ 'Flow JSON í”„ë¡¬í”„íŠ¸'ì™€ 'ë¯¸ë“œì €ë‹ˆ í”„ë¡¬í”„íŠ¸'ë¡œ ë³€í™˜í•˜ëŠ” ì „ë¬¸ AIì…ë‹ˆë‹¤.
ì‚¬ìš©ìê°€ ì…ë ¥í•œ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì•„ë˜ì˜ [ì¡°ê±´]ê³¼ [ì–‘ì‹]ì„ ì™„ë²½í•˜ê²Œ ì¤€ìˆ˜í•˜ì—¬ ë‹µë³€í•˜ì„¸ìš”.

[ì¡°ê±´ 1: Flow JSON ì‘ì„±]
- ì…ë ¥ëœ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ JSONì˜ "___" ë¶€ë¶„ì„ ì˜ë¬¸ìœ¼ë¡œ ë²ˆì—­í•˜ì—¬ ì±„ìš°ì„¸ìš”.
- JSON êµ¬ì¡°(Keyê°’)ë¥¼ ì ˆëŒ€ ë³€ê²½í•˜ê±°ë‚˜ ì‚­ì œí•˜ì§€ ë§ˆì„¸ìš”.

[ì¡°ê±´ 2: ëˆ„ë½ ë°ì´í„° ì²˜ë¦¬]
- ì…ë ¥ ë‚´ìš©ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ëŠ” ì •ë³´ëŠ” "none"ì´ë¼ê³  ê¸°ì…í•˜ì„¸ìš”.
- JSON ì‘ì„± í›„, í•˜ë‹¨ì— 'Flow ì‚¬ìš© json í”„ë¡¬í”„íŠ¸ ì¤‘ ëˆ„ë½ / none ë¶€ë¶„'ì„ ë³„ë„ë¡œ ì •ë¦¬í•˜ì„¸ìš”.

[ì¡°ê±´ 3: ë¯¸ë“œì €ë‹ˆ í”„ë¡¬í”„íŠ¸ ì‘ì„±]
- ëª¨ë“  ë‚´ìš©ì€ ì˜ë¬¸ìœ¼ë¡œ ë²ˆì—­ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
- ë‹¤ìŒ ìˆœì„œë¥¼ ë°˜ë“œì‹œ ì§€ì¼œì„œ ì¡°í•©í•˜ì„¸ìš”:
  ì£¼ì œ(Topic) â†’ ì•¡ì…˜(Action) â†’ ë°°ê²½(Background) â†’ ì¹´ë©”ë¼ ì›€ì§ì„(Camera) â†’ ìŠ¤íƒ€ì¼(Style) â†’ êµ¬ë„(Composition)
- ê° ìš”ì†ŒëŠ” ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„í•˜ì„¸ìš”.

[ì¡°ê±´ 4: ë¯¸ë“œì €ë‹ˆ ëˆ„ë½ í™•ì¸]
- ë¯¸ë“œì €ë‹ˆ í”„ë¡¬í”„íŠ¸ ì‘ì„± í›„, ë¶€ì¡±í•˜ê±°ë‚˜ ë¹ ì§„ ìš”ì†Œë¥¼ í•˜ë‹¨ì— ì •ë¦¬í•˜ì„¸ìš”.

[ì¶œë ¥ ì–‘ì‹]
1ï¸âƒ£ Flow ì‚¬ìš© json í”„ë¡¬í”„íŠ¸
- JSON ì½”ë“œ ë¸”ëŸ­ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥

âš ï¸ Flow ì‚¬ìš© json í”„ë¡¬í”„íŠ¸ ì¤‘ ëˆ„ë½ / none ë¶€ë¶„
- ëˆ„ë½ëœ í•­ëª© ëª©ë¡ì„ ë§ˆí¬ë‹¤ìš´ ë¦¬ìŠ¤íŠ¸ë¡œ ì¶œë ¥

2ï¸âƒ£ ë¯¸ë“œì €ë‹ˆ ì‚¬ìš© í”„ë¡¬í”„íŠ¸
- í•œ ì¤„ì§œë¦¬ ì˜ë¬¸ í”„ë¡¬í”„íŠ¸ë¡œ ì¶œë ¥
- êµ¬ì„± ìˆœì„œ: ì£¼ì œ, ì•¡ì…˜, ë°°ê²½, ì¹´ë©”ë¼ ì›€ì§ì„, ìŠ¤íƒ€ì¼, êµ¬ë„ (ê° ìš”ì†ŒëŠ” ì‰¼í‘œë¡œ êµ¬ë¶„)

âš ï¸ ë¯¸ë“œì €ë‹ˆ ì‚¬ìš© í”„ë¡¬í”„íŠ¸ ì¤‘ ëˆ„ë½ë¶€ë¶„
- ë¶€ì¡±í•˜ê±°ë‚˜ ë¹ ì§„ ìš”ì†Œë¥¼ ë¦¬ìŠ¤íŠ¸ë¡œ ì •ë¦¬

[JSON í…œí”Œë¦¿]

{
  "topic_and_content": {
    "description": "___"
  },
  "character": {
    "gender": "___",
    "appearance": {
      "nationality": "___",
      "age": "___",
      "eye_color": "___",
      "scar": "___",
      "hair": "___"
    },
    "clothing": "___",
    "emotions_sequence": [
      "___",
      "___",
      "___"
    ]
  },
  "action": {
    "sequence": [
      "___",
      "___",
      "___",
      "___"
    ],
    "object_interaction": [
      "___",
      "___",
      "___"
    ]
  },
  "background": {
    "location": "___",
    "time_of_day": "___",
    "elements": [
      "___",
      "___"
    ],
    "weather": "___",
    "scene_lighting": "___"
  },
  "camera_work": {
    "sequence": [
      {
        "duration": 3,
        "shot_type": "___",
        "description": "___"
      },
      {
        "duration": 4,
        "shot_type": "___",
        "description": "___"
      }
    ],
    "lens": "___",
    "effects": [
      "___"
    ]
  },
  "style": {
    "genre": "___",
    "style_lighting": "___",
    "film_grain": "___",
    "color_palette": "___",
    "mood": "___"
  },
  "aspect_ratio": "___",
  "requirements": "full-size video without letterboxes"
}

[Flow ì‚¬ìš© json í”„ë¡¬í”„íŠ¸ ì¤‘ ëˆ„ë½ / none ë¶€ë¶„ ì˜ˆì‹œ]

1. character.appearance.eye_color : ëˆˆ ìƒ‰ìƒ ì •ë³´ ì—†ìŒ
2. character.appearance.scar : í‰í„° ìœ ë¬´ ì •ë³´ ì—†ìŒ

[ë¯¸ë“œì €ë‹ˆ ì‚¬ìš© í”„ë¡¬í”„íŠ¸ ì¶œë ¥ ì˜ˆì‹œ]

Topic, Action, Background, Camera movement, Style, Composition

[ë¯¸ë“œì €ë‹ˆ ì‚¬ìš© í”„ë¡¬í”„íŠ¸ ì¤‘ ëˆ„ë½ë¶€ë¶„ ì˜ˆì‹œ]

1. ì¹´ë©”ë¼ ì›€ì§ì„ ê´€ë ¨ êµ¬ì²´ì ì¸ í‘œí˜„ ë¶€ì¡±
2. ì¡°ëª… ìŠ¤íƒ€ì¼ êµ¬ì²´ ì •ë³´ ë¶€ì¡±
"""

# ==============================================================================
# [2] Streamlit UI
# ==============================================================================
st.set_page_config(page_title="Flow + Midjourney Prompt Converter (OpenAI)", layout="wide")

st.title("Flow JSON + Midjourney í”„ë¡¬í”„íŠ¸ ë³€í™˜ê¸° (OpenAI ì „ìš©)")
st.caption("í•œê¸€ ì„¤ëª… â†’ Flowìš© JSON í”„ë¡¬í”„íŠ¸ + ë¯¸ë“œì €ë‹ˆìš© ì˜ë¬¸ í”„ë¡¬í”„íŠ¸ ìë™ ìƒì„±")

with st.sidebar:
    st.subheader("ğŸ” API ì„¤ì •")
    st.markdown(
        "- OpenAI API KeyëŠ” Streamlit Secretsì— `openai_api_key` ë¡œ ì €ì¥ë˜ì–´ ì‚¬ìš©ë©ë‹ˆë‹¤.\n"
        "- ì´ í™”ë©´ì—ì„œëŠ” ë³„ë„ì˜ í‚¤ ì…ë ¥ì´ í•„ìš” ì—†ìŠµë‹ˆë‹¤."
    )
    st.markdown("---")
    st.markdown("**ì‚¬ìš© ëª¨ë¸:** `gpt-4.1-mini` (ì›í•˜ë©´ ì½”ë“œì—ì„œ ë³€ê²½ ê°€ëŠ¥)")

st.markdown("### 1. í”„ë¡¬í”„íŠ¸ë¡œ ì‚¬ìš©í•  ë‚´ìš©ì„ í•œêµ­ì–´ë¡œ ì…ë ¥í•˜ì„¸ìš”.")
default_text = "ë°ì€ ë¯¸ì†Œë¥¼ ì§“ëŠ” 20ëŒ€ í•œêµ­ì¸ ì—¬ì„± ì¸ë¬¼, ë„ì‹¬ ì¹´í˜ í…Œë¼ìŠ¤ì—ì„œ ë…¸íŠ¸ë¶ìœ¼ë¡œ ì‘ì—…í•˜ëŠ” ì¥ë©´"
user_input = st.text_area(
    "ì„¤ëª… ì…ë ¥",
    value=default_text,
    height=200,
    placeholder="ì—¬ê¸°ì— ì¸ë¬¼, í–‰ë™, ë°°ê²½, ë¶„ìœ„ê¸° ë“±ì„ í•œêµ­ì–´ë¡œ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”."
)

generate_btn = st.button("ğŸš€ í”„ë¡¬í”„íŠ¸ ìƒì„±í•˜ê¸°")

# ==============================================================================
# [3] OpenAI í˜¸ì¶œ í•¨ìˆ˜
# ==============================================================================
def ask_openai(prompt: str) -> str:
    client = OpenAI(api_key=OPENAI_API_KEY)

    response = client.chat.completions.create(
        model = "gpt-4.1-mini",  # í•„ìš”í•˜ë©´ gpt-4.1 / gpt-4.1-mini ë“±ìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥
        messages=[
            {"role": "system", "content": SYSTEM_INSTRUCTION},
            {"role": "user", "content": prompt},
        ],
        temperature=0.3,
    )
    return response.choices[0].message.content


# ==============================================================================
# [4] ìƒì„± ë¡œì§
# ==============================================================================
if generate_btn:
    if not OPENAI_API_KEY:
        st.error("OPENAI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Secretsì— 'openai_api_key'ë¥¼ ë“±ë¡í•´ ì£¼ì„¸ìš”.")
    elif not user_input.strip():
        st.error("ì„¤ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.")
    else:
        try:
            with st.spinner("OpenAIê°€ í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤..."):
                result_text = ask_openai(user_input)

        st.success("í”„ë¡¬í”„íŠ¸ ìƒì„± ì™„ë£Œ!")

            # 4) ê²°ê³¼ í‘œì‹œ (ì™¼ìª½/ì˜¤ë¥¸ìª½ ë‚˜ëˆ ì„œ ë³´ê¸° ì¢‹ê²Œ)
            left, right = st.columns(2)

            # ğŸ”¹ ì™¼ìª½: ì „ì²´ ê²°ê³¼ ê·¸ëŒ€ë¡œ
            with left:
                st.markdown("### ğŸ§© ì „ì²´ ê²°ê³¼ (Markdown)")
                st.markdown(result_text)

            # ğŸ”¹ ì˜¤ë¥¸ìª½: ë¯¸ë“œì €ë‹ˆ í”„ë¡¬í”„íŠ¸ë§Œ ì½”ë“œ ë°•ìŠ¤ë¡œ ì¶”ì¶œ
            # -------------------------------------------------
            # 1) ê¸°ì¤€ì´ ë˜ëŠ” ì œëª©(ë§ˆì»¤) ì •ì˜
            marker_1 = "### 2ï¸âƒ£ ë¯¸ë“œì €ë‹ˆ ì‚¬ìš© í”„ë¡¬í”„íŠ¸"
            marker_2 = "2ï¸âƒ£ ë¯¸ë“œì €ë‹ˆ ì‚¬ìš© í”„ë¡¬í”„íŠ¸"

            mj_block = None
            text = result_text

            # 2) ë¯¸ë“œì €ë‹ˆ ì„¹ì…˜ ì‹œì‘ ìœ„ì¹˜ ì°¾ê¸°
            if marker_1 in text:
                text = text.split(marker_1, 1)[1]
            elif marker_2 in text:
                text = text.split(marker_2, 1)[1]

            # 3) ì°¾ì•˜ë‹¤ë©´, ê·¸ ë’¤ì—ì„œ ë‹¤ìŒ ì„¹ì…˜(###, âš ï¸ ë“±) ë‚˜ì˜¤ê¸° ì „ê¹Œì§€ë§Œ ì‚¬ìš©
            if text != result_text:
                for end_marker in [
                    "### âš ï¸",          # âš ï¸ ì„¹ì…˜
                    "âš ï¸ ë¯¸ë“œì €ë‹ˆ",     # í˜¹ì‹œ ë‹¤ë¥¸ í˜•ì‹
                    "### 3ï¸âƒ£",         # ë‹¤ìŒ ë²ˆí˜¸ ì„¹ì…˜
                    "### 1ï¸âƒ£",         # ì²« ì„¹ì…˜ìœ¼ë¡œ ëŒì•„ê°€ëŠ” ê²½ìš°
                    "\n### "
                ]:
                    if end_marker in text:
                        text = text.split(end_marker, 1)[0]
                        break

                mj_block = text.strip()

            with right:
                st.markdown("### ğŸ¨ Midjourney í”„ë¡¬í”„íŠ¸ (ì½”ë“œ ë³µì‚¬ìš©)")

                if mj_block:
                    # í˜¹ì‹œ LLMì´ ì•ˆì— ``` ê°™ì€ ê±¸ ë„£ì—ˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ ì œê±°
                    cleaned = mj_block.strip().strip("`").strip()
                    st.code(cleaned, language="text")
                else:
                    st.info("ê²°ê³¼ì—ì„œ 'ë¯¸ë“œì €ë‹ˆ ì‚¬ìš© í”„ë¡¬í”„íŠ¸' êµ¬ê°„ì„ ì°¾ì§€ ëª»í–ˆì–´ìš”. ì‹œìŠ¤í…œ ì¸ìŠ¤íŠ¸ëŸ­ì…˜ í˜•ì‹ì„ í•œ ë²ˆ ì²´í¬í•´ ì£¼ì„¸ìš”.")
                    st.code(result_text, language="text")


        except Exception as e:
            st.error(f"ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
