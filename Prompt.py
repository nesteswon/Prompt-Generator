import streamlit as st
import google.generativeai as genai

GOOGLE_API_KEY = st.secrets["google_api_key"]
OPENAI_API_KEY = st.secrets["openai_api_key"]

# ==============================================================================
# [1] System Instruction ì„¤ì • (ì—­í•  + ê·œì¹™)
# ==============================================================================
SYSTEM_INSTRUCTION = """
ë‹¹ì‹ ì€ ì…ë ¥ëœ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ 'Flow JSON í”„ë¡¬í”„íŠ¸'ì™€ 'ë¯¸ë“œì €ë‹ˆ í”„ë¡¬í”„íŠ¸'ë¡œ ë³€í™˜í•˜ëŠ” ì „ë¬¸ AIì…ë‹ˆë‹¤.
ì‚¬ìš©ìê°€ ì…ë ¥í•œ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì•„ë˜ì˜ [ì¡°ê±´]ê³¼ [ì–‘ì‹]ì„ ì™„ë²½í•˜ê²Œ ì¤€ìˆ˜í•˜ì—¬ ë‹µë³€í•˜ì„¸ìš”.

[ì¡°ê±´ 1: Flow JSON ì‘ì„±]
- ì…ë ¥ëœ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ JSONì˜ "___" ë¶€ë¶„ì„ ì˜ë¬¸ìœ¼ë¡œ ë²ˆì—­í•˜ì—¬ ì±„ìš°ì„¸ìš”.
- JSON êµ¬ì¡°(Keyê°’)ë¥¼ ì ˆëŒ€ ë³€ê²½í•˜ê±°ë‚˜ ì‚­ì œí•˜ì§€ ë§ˆì„¸ìš”.

[ì¡°ê±´ 2: ëˆ„ë½ ë°ì´í„° ì²˜ë¦¬]
- ì…ë ¥ ë‚´ìš©ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ëŠ” ì •ë³´ëŠ” "none"ì´ë¼ê³  ê¸°ì…í•˜ì„¸ìš”.
- JSON ì‘ì„± í›„, í•˜ë‹¨ì— 'Flow ì‚¬ìš© json í”„ë¡¬í”„íŠ¸ ì¤‘ ëˆ„ë½ / none ë¶€ë¶„'ì„ ë³„ë„ë¡œ ì •ë¦¬í•˜ì„¸ìš”.

[ì¡°ê±´ 3: ë¯¸ë“œì €ë‹ˆ í”„ë¡¬í”„íŠ¸ ì‘ì„±]
- ëª¨ë“  ë‚´ìš©ì€ ì˜ë¬¸ìœ¼ë¡œ ë²ˆì—­ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
- ë‹¤ìŒ ìˆœì„œë¥¼ ë°˜ë“œì‹œ ì§€ì¼œì„œ ì¡°í•©í•˜ì„¸ìš”:
  ì£¼ì œ(Topic) â†’ ì•¡ì…˜(Action) â†’ ë°°ê²½(Background) â†’ ì¹´ë©”ë¼ ì›€ì§ì„(Camera) â†’ ìŠ¤íƒ€ì¼(Style) â†’ êµ¬ë„(Composition)
- ê° ìš”ì†ŒëŠ” ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„í•˜ì„¸ìš”.

[ì¡°ê±´ 4: ë¯¸ë“œì €ë‹ˆ ëˆ„ë½ í™•ì¸]
- ë¯¸ë“œì €ë‹ˆ í”„ë¡¬í”„íŠ¸ ì‘ì„± í›„, ë¶€ì¡±í•˜ê±°ë‚˜ ë¹ ì§„ ìš”ì†Œë¥¼ í•˜ë‹¨ì— ì •ë¦¬í•˜ì„¸ìš”.

[ì¶œë ¥ ì–‘ì‹]
1ï¸âƒ£ Flow ì‚¬ìš© json í”„ë¡¬í”„íŠ¸
- JSON ì½”ë“œ ë¸”ëŸ­ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥

âš ï¸ Flow ì‚¬ìš© json í”„ë¡¬í”„íŠ¸ ì¤‘ ëˆ„ë½ / none ë¶€ë¶„
- ëˆ„ë½ëœ í•­ëª© ëª©ë¡ì„ ë§ˆí¬ë‹¤ìš´ ë¦¬ìŠ¤íŠ¸ë¡œ ì¶œë ¥

2ï¸âƒ£ ë¯¸ë“œì €ë‹ˆ ì‚¬ìš© í”„ë¡¬í”„íŠ¸
- í•œ ì¤„ì§œë¦¬ ì˜ë¬¸ í”„ë¡¬í”„íŠ¸ë¡œ ì¶œë ¥
- êµ¬ì„± ìˆœì„œ: ì£¼ì œ, ì•¡ì…˜, ë°°ê²½, ì¹´ë©”ë¼ ì›€ì§ì„, ìŠ¤íƒ€ì¼, êµ¬ë„ (ê° ìš”ì†ŒëŠ” ì‰¼í‘œë¡œ êµ¬ë¶„)

âš ï¸ ë¯¸ë“œì €ë‹ˆ ì‚¬ìš© í”„ë¡¬í”„íŠ¸ ì¤‘ ëˆ„ë½ë¶€ë¶„
- ë¶€ì¡±í•˜ê±°ë‚˜ ë¹ ì§„ ìš”ì†Œë¥¼ ë¦¬ìŠ¤íŠ¸ë¡œ ì •ë¦¬

[JSON í…œí”Œë¦¿]

{
  "topic_and_content": {
    "description": "___"
  },
  "character": {
    "gender": "___",
    "appearance": {
      "nationality": "___",
      "age": "___",
      "eye_color": "___",
      "scar": "___",
      "hair": "___"
    },
    "clothing": "___",
    "emotions_sequence": [
      "___",
      "___",
      "___"
    ]
  },
  "action": {
    "sequence": [
      "___",
      "___",
      "___",
      "___"
    ],
    "object_interaction": [
      "___",
      "___",
      "___"
    ]
  },
  "background": {
    "location": "___",
    "time_of_day": "___",
    "elements": [
      "___",
      "___"
    ],
    "weather": "___",
    "scene_lighting": "___"
  },
  "camera_work": {
    "sequence": [
      {
        "duration": 3,
        "shot_type": "___",
        "description": "___"
      },
      {
        "duration": 4,
        "shot_type": "___",
        "description": "___"
      }
    ],
    "lens": "___",
    "effects": [
      "___"
    ]
  },
  "style": {
    "genre": "___",
    "style_lighting": "___",
    "film_grain": "___",
    "color_palette": "___",
    "mood": "___"
  },
  "aspect_ratio": "___",
  "requirements": "full-size video without letterboxes"
}

[Flow ì‚¬ìš© json í”„ë¡¬í”„íŠ¸ ì¤‘ ëˆ„ë½ / none ë¶€ë¶„ ì˜ˆì‹œ]

1. character.appearance.eye_color : ëˆˆ ìƒ‰ìƒ ì •ë³´ ì—†ìŒ
2. character.appearance.scar : í‰í„° ìœ ë¬´ ì •ë³´ ì—†ìŒ

[ë¯¸ë“œì €ë‹ˆ ì‚¬ìš© í”„ë¡¬í”„íŠ¸ ì¶œë ¥ ì˜ˆì‹œ]

Topic, Action, Background, Camera movement, Style, Composition

[ë¯¸ë“œì €ë‹ˆ ì‚¬ìš© í”„ë¡¬í”„íŠ¸ ì¤‘ ëˆ„ë½ë¶€ë¶„ ì˜ˆì‹œ]

1. ì¹´ë©”ë¼ ì›€ì§ì„ ê´€ë ¨ êµ¬ì²´ì ì¸ í‘œí˜„ ë¶€ì¡±
2. ì¡°ëª… ìŠ¤íƒ€ì¼ êµ¬ì²´ ì •ë³´ ë¶€ì¡±
"""

# ==============================================================================
# [2] Streamlit UI
# ==============================================================================
st.set_page_config(page_title="Flow + Midjourney Prompt Converter", layout="wide")

st.title("Flow JSON + Midjourney í”„ë¡¬í”„íŠ¸ ë³€í™˜ê¸°")
st.caption("í•œê¸€ë¡œ ì„¤ëª…ì„ ì…ë ¥í•˜ë©´, Flowìš© JSON í”„ë¡¬í”„íŠ¸ì™€ ë¯¸ë“œì €ë‹ˆìš© ì˜ë¬¸ í”„ë¡¬í”„íŠ¸ë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.")

with st.sidebar:
    st.subheader("ğŸ” Google API ì„¤ì •")
    api_key = st.text_input(
        "Google API Key (AIzaë¡œ ì‹œì‘)",
        type="password",
        help="Google AI Studioì—ì„œ ë°œê¸‰ë°›ì€ API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”."
    )
    st.markdown(
        "- í‚¤ëŠ” ì‹¤í–‰ ì¤‘ ë©”ëª¨ë¦¬ì—ë§Œ ì‚¬ìš©ë˜ê³ , ì•±ì— ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n"
        "- ì„±ëŠ¥/ë¹„ìš©ì„ ìœ„í•´ gemini-1.5-flash ëª¨ë¸ì„ ì‚¬ìš©í•©ë‹ˆë‹¤."
    )

st.markdown("### 1. í”„ë¡¬í”„íŠ¸ë¡œ ì‚¬ìš©í•  ë‚´ìš©ì„ í•œêµ­ì–´ë¡œ ì…ë ¥í•˜ì„¸ìš”.")
default_text = "ë°ì€ ë¯¸ì†Œë¥¼ ì§“ëŠ” 20ëŒ€ í•œêµ­ì¸ ì—¬ì„± ì¸ë¬¼, ë„ì‹¬ ì¹´í˜ í…Œë¼ìŠ¤ì—ì„œ ë…¸íŠ¸ë¶ìœ¼ë¡œ ì‘ì—…í•˜ëŠ” ì¥ë©´"
user_input = st.text_area(
    "ì„¤ëª… ì…ë ¥",
    value=default_text,
    height=200,
    placeholder="ì—¬ê¸°ì— ì¸ë¬¼, í–‰ë™, ë°°ê²½, ë¶„ìœ„ê¸° ë“±ì„ í•œêµ­ì–´ë¡œ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”."
)

generate_btn = st.button("ğŸš€ í”„ë¡¬í”„íŠ¸ ìƒì„±í•˜ê¸°")

# ==============================================================================
# [3] ìƒì„± ë¡œì§
# ==============================================================================
if generate_btn:
    if not api_key:
        st.error("ë¨¼ì € ì‚¬ì´ë“œë°”ì— Google API Keyë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.")
    elif not user_input.strip():
        st.error("ì„¤ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.")
    else:
        try:
            # 1) í‚¤ ì„¤ì •
            genai.configure(api_key=api_key)

            # 2) ëª¨ë¸ ìƒì„± (system_instruction í¬í•¨)
            model = genai.GenerativeModel(
                "gemini-1.5-flash",
                system_instruction=SYSTEM_INSTRUCTION
            )

            # 3) ì½˜í…ì¸  ìƒì„±
            with st.spinner("í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤..."):
                response = model.generate_content(
                    contents=user_input
                )

            result_text = response.text if hasattr(response, "text") else str(response)

            st.success("í”„ë¡¬í”„íŠ¸ ìƒì„± ì™„ë£Œ!")

            # 4) ê²°ê³¼ í‘œì‹œ (ì™¼ìª½/ì˜¤ë¥¸ìª½ ë‚˜ëˆ ì„œ ë³´ê¸° ì¢‹ê²Œ)
            left, right = st.columns(2)

            with left:
                st.markdown("### ğŸ§© ì „ì²´ ê²°ê³¼ (Markdown)")
                st.markdown(result_text)

            with right:
                st.markdown("### ğŸ“‹ ì›ë³¸ í…ìŠ¤íŠ¸")
                st.code(result_text)

        except Exception as e:
            st.error(f"ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
